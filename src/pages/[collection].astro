---
import type { ImageMetadata } from 'astro';
import { getCollection } from 'astro:content';
import { Image } from 'astro:assets';
import GridEntry from '../components/GridEntry';
import PageHeader from '../components/PageHeader';
import Banner from '../components/Banner'
import Footer from '../components/Footer'
import '../styles/Global.scss'
import '../styles/GridDisplay.scss'

const titleLookup = {
    "engineering":"Engineering & Software",
    "metals": "Metals & Jewelry"
}

export async function getStaticPaths() {
    const collections = ['engineering', 'metals'] as const;
    return collections.map((collection) => ({
        params: { collection },
    }));
}

const { collection } = Astro.params;

const postsInCollection = (await getCollection(collection)).sort((a, b) => {
    const orderA = a.data.order;
    const orderB = b.data.order;
    if (orderA != null && orderB != null) {
        return orderA - orderB;
    }
    if (orderA != null) {
        return -1;
    }
    if (orderB != null) {
        return 1;
    }
    return 0;
});

const allThumbs = Object.entries(
    import.meta.glob<{ default: ImageMetadata }>(
        '/src/img/*/*/thumb.*'
    )
);

const thumbs = allThumbs
    .map(([path, loader]) => {
        const match = new RegExp(`/${collection}/([^/]+)/thumb`).exec(path);
        if (!match) return null;
        
        return {
            id: match[1],
            path: loader,
        };
    })
    .filter(Boolean);

const posts = postsInCollection
    .map((post) => ({
        text: post.data.listingTitle,
        id: post.data.id,
        image: thumbs.find((t) => t.id === post.data.id)?.path,
    }))
    .filter((p) => p.image);

---
<html lang="en">
<head>
    <title>{collection}</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
</head>
<body>
    <Banner client:only />
    <div class="main">
        <Banner sticky={false}/>
        <PageHeader text={titleLookup[collection]} client:only></PageHeader>
        <div class="gridInstructions">Click a picture below to read more.</div>
        <div class="grid">
            {posts.map((p) => (
                <GridEntry name={p.text} path={`/${collection}/${p.id}`}>
                    <Image slot="image" class="gridEntryImage" src={p.image()} alt={p.id}></Image>
                </GridEntry>
            ))}
        </div>
        <div class="spacer"></div>
        <Footer client:only />
    </div>
    </body>
    </html>
    